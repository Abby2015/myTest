var Game={initParams:function(){Game.Target={startX:0,shakeTime:200,movedDuration:1,moveStartTime:0};Game.Clock={updateTimer:null,timeInfo:[0,0]};Game.Ball={originPosition:{x:0,y:0},startPosition:{},movePosition:{},timer:0,total:10,speed:200,duration:0,radian:0,distance:0,deg:0,success:false,direction:"left",levelUnit:0};Game.Result={score:0,time:0,flag:0};this.setUnit1();},initTarget:function(){Game.Target.startX=$(".page3 .ice").offset().left;var a=window.innerWidth-$(".page3 .ice").width();targetAnimation=new JS2CSSKeyframes("targetAnimation",{from:"transform:translate(0px,0px);",to:"transform:translate("+a+"px,0px);"});$(".page3 .ice").css({"-webkit-animation":"targetAnimation "+Game.Target.movedDuration+"s linear alternate infinite","-moz-animation":"targetAnimation "+Game.Target.movedDuration+"s linear alternate infinite","-o-animation":"targetAnimation "+Game.Target.movedDuration+"s linear alternate infinite","-ms-animation":"targetAnimation "+Game.Target.movedDuration+"s linear alternate infinite","animation":"targetAnimation "+Game.Target.movedDuration+"s linear alternate infinite"});$(".page3 .ice").unbind("touchstart").unbind("touchmove").unbind("touchend");$(".page3 .ice").bind("touchstart",function(b){event.preventDefault();}).bind("touchmove",function(b){event.preventDefault();}).bind("touchend",function(b){event.preventDefault();});},initClock:function(){Game.Clock.updateTimer=setInterval(function(){Game.Clock.timeInfo[1]++;if(Game.Clock.timeInfo[1]>9){Game.Clock.timeInfo[0]++;Game.Clock.timeInfo[1]=0;}$(".page3 .time_button>span").text(Game.Clock.timeInfo.join(":"));},100);},initBallAndBow:function(){var b=startY=endTouchPageX=endTouchPageY=0;var a=$(".ballmain .r").height(),c=$(".page3 .ballmain .ball").width();Game.Ball.originPosition.x=$(".ballmain .l").height();Game.Ball.originPosition.top=$(".ballmain .l").offset().top;$(".page3 .slingshot").unbind("touchstart").unbind("touchmove").unbind("touchend");$(".page3 .slingshot").bind("touchstart",function(d){event.preventDefault();Game.Ball.startPosition.x=b=event.touches[0].pageX;Game.Ball.startPosition.y=startY=event.touches[0].pageY;$(".page3 .hand").hide();}).bind("touchmove",function(d){event.preventDefault();endTouchPageX=event.touches[0].pageX;endTouchPageY=parseInt(event.touches[0].pageY);if(endTouchPageY>startY){Game.Ball.movePosition.x=endTouchPageX-b+Game.Ball.originPosition.x;Game.Ball.movePosition.y=endTouchPageY-startY+Game.Ball.originPosition.y;Game.Ball.movePosition.rotateL=Math.atan2(Game.Ball.movePosition.y,Game.Ball.movePosition.x)*180/Math.PI-90;Game.Ball.movePosition.rotateR=(Math.atan2(Game.Ball.movePosition.y,2*a-Game.Ball.movePosition.x)*180/Math.PI-90)*-1;$(".page3 .ballmain .ball").css("transform","translate("+(Game.Ball.movePosition.x)+"px,"+Game.Ball.movePosition.y+"px)");$(".ballmain .l").css({"height":Math.sqrt(Math.pow(Game.Ball.movePosition.x,2)+Math.pow(Game.Ball.movePosition.y,2))-5,"transform":"rotate("+Game.Ball.movePosition.rotateL+"deg)","-webkit-transform":"rotate("+Game.Ball.movePosition.rotateL+"deg)","-moz-transform":"rotate("+Game.Ball.movePosition.rotateL+"deg)","-o-transform":"rotate("+Game.Ball.movePosition.rotateL+"deg)","-ms-transform":"rotate("+Game.Ball.movePosition.rotateL+"deg)"});$(".ballmain .r").css({"height":Math.sqrt(Math.pow(2*a-Game.Ball.movePosition.x,2)+Math.pow(Game.Ball.movePosition.y,2))-5,"transform":"rotate("+Game.Ball.movePosition.rotateR+"deg)","-webkit-transform":"rotate("+Game.Ball.movePosition.rotateR+"deg)","-moz-transform":"rotate("+Game.Ball.movePosition.rotateR+"deg)","-o-transform":"rotate("+Game.Ball.movePosition.rotateR+"deg)","-ms-transform":"rotate("+Game.Ball.movePosition.rotateR+"deg)"});}}).bind("touchend",function(d){event.preventDefault();if((endTouchPageX!=0||endTouchPageY!=0)&&(endTouchPageY>startY)){Game.drawDirection(b,startY,endTouchPageX,endTouchPageY);Game.forcastResult(b,startY,endTouchPageX,endTouchPageY,a);Game.updateStatus();}else{$(".page3 .hand").show();}});},init:function(){this.initParams();this.initTarget();this.initClock();this.initBallAndBow();},setUnit:function(){var b=window.innerHeight,a=speedUnit=timeUnit=0;if(b<=480){a=40;speedUnit=20;timeUnit=10;}else{if(b<=568){a=30;speedUnit=35;timeUnit=20;}else{if(b<=667){a=25;speedUnit=45;timeUnit=30;}else{if(b<=736){a=20;speedUnit=50;timeUnit=40;}}}}Game.Ball.levelUnit=a;Game.Ball.speedUnit=speedUnit;Game.Ball.timeUnit=timeUnit;},setUnit1:function(){Game.Ball.levelUnit=Math.ceil(window.innerHeight/10);Game.Ball.speedUnit=(window.innerHeight-$(".page3 .ice").offset().top)/6;Game.Ball.timeUnit=Math.floor($(".page3 .ballmain").height()/8);},setBallSpeed:function(b,a,e,c){var f=Math.sqrt(Math.pow(e-b,2)+Math.pow(c-a,2));var g=parseInt(f/Game.Ball.levelUnit);if(g>8){g=8;}else{if(g<1){g=1;}}Game.Ball.speed=g*Game.Ball.speedUnit;},setBallFlyingTime:function(b,a,d,c){Game.Ball.duration=parseInt(Math.abs(c-a)/Game.Ball.timeUnit);},drawDirection:function(b,a,e,c){var g=Math.atan(Math.abs(a-c)/Math.abs(b-e));var d=Math.round(g*(180/Math.PI));var f="left";if(e>b){f="left";}else{if(e==b){f="up";}else{f="right";}}Game.Ball["direction"]=f;Game.Ball["radian"]=g;Game.Ball["deg"]=d;this.setBallSpeed(b,a,e,c);this.setBallFlyingTime(b,a,e,c);},forcastResult:function(j,i,e,d,a){var f=Game.Ball.speed,b=Game.Ball.duration,k=newBallY=0;Game.Ball.distance=b*f;var c=Game.Ball.distance*Math.cos(Game.Ball["radian"]),l=-(Game.Ball.distance*Math.sin(Game.Ball["radian"])),h=e+Math.round($(".ballmain .ball").width()/2),g=d+Math.round($(".ballmain .ball").width()/2);if(Game.Ball.direction=="left"){c=-c;}k=h+c;newBallY=g+l;if(k>$(".page3 .target").offset().left&&k<$(".page3 .target").offset().left+$(".page3 .target").width()&&newBallY>$(".page3 .target").offset().top&&newBallY<$(".page3 .target").offset().top+$(".page3 .target").height()){Game.Ball.success=true;}else{Game.Ball.success=false;}this.ballFlying(c,l,e,d,j,i,a);},shakeTarget:function(){var a=$(".page3 .ice").offset().left;$(".page3 .ice").removeAttr("style");$(".page3 .ice").css({"left":a+"px","-webkit-animation":"shake-opacity 1s linear alternate 1","-moz-animation":"shake-opacity 1s linear alternate 1","-o-animation":"shake-opacity 1s linear alternate 1","-ms-animation":"shake-opacity 10s linear alternate 1","animation":"shake-opacity 1s linear alternate 1"});setTimeout(function(){var b=new Date();Game.Target.moveStartTime=b.getTime();$(".page3 .ice").css({"left":Game.Target.startX+"px","-webkit-animation":"targetAnimation "+Game.Target.movedDuration+"s linear alternate infinite","-moz-animation":"targetAnimation "+Game.Target.movedDuration+"s linear alternate infinite","-o-animation":"targetAnimation "+Game.Target.movedDuration+"s linear alternate infinite","-ms-animation":"targetAnimation "+Game.Target.movedDuration+"s linear alternate infinite","animation":"targetAnimation "+Game.Target.movedDuration+"s linear alternate infinite"});},1000);},ballFlying:function(g,f,h,e,c,b,a){new JS2CSSKeyframes("fly",{from:"transform:translate(0px,0px);",to:"transform:translate("+g+"px,"+f+"px);"});var d=$(".ballmain .ball").width();$(".ballmain .ball").hide();$(".flyball").show().css({"left":(h-d/2)+"px","top":(e-d/2)+"px","-webkit-animation":"fly 1300ms linear normal 1","-moz-animation":"fly 1300ms linear normal 1","-o-animation":"fly 1300ms linear normal 1","-ms-animation":"fly 1300ms linear normal 1","animation":"fly 1300ms linear normal 1"});Game.resetBow(c,b,a);setTimeout(function(){if(Game.Ball.success==true){Game.shakeTarget();}Game.resetBall();},1300);},resetBow:function(d,b,a){Game.Ball.bowMovePosition={};var c=null,e=$(".page3 .ballmain .ball").width();c=setInterval(function(){var g=$(".flyball").offset().left+e/2,f=$(".flyball").offset().top+e;Game.Ball.bowMovePosition.x=g-d+Game.Ball.originPosition.x;Game.Ball.bowMovePosition.y=f-b+Game.Ball.originPosition.y;Game.Ball.bowMovePosition.rotateL=Math.atan2(Game.Ball.bowMovePosition.y,Game.Ball.bowMovePosition.x)*180/Math.PI-90;Game.Ball.bowMovePosition.rotateR=(Math.atan2(Game.Ball.bowMovePosition.y,2*a-Game.Ball.bowMovePosition.x)*180/Math.PI-90)*-1;$(".ballmain .l").css({"height":Math.sqrt(Math.pow(Game.Ball.bowMovePosition.x,2)+Math.pow(Game.Ball.bowMovePosition.y,2))-2,"transform":"rotate("+Game.Ball.bowMovePosition.rotateL+"deg)","-webkit-transform":"rotate("+Game.Ball.bowMovePosition.rotateL+"deg)","-moz-transform":"rotate("+Game.Ball.bowMovePosition.rotateL+"deg)","-o-transform":"rotate("+Game.Ball.bowMovePosition.rotateL+"deg)","-ms-transform":"rotate("+Game.Ball.bowMovePosition.rotateL+"deg)"});$(".ballmain .r").css({"height":Math.sqrt(Math.pow(2*a-Game.Ball.bowMovePosition.x,2)+Math.pow(Game.Ball.bowMovePosition.y,2))-2,"transform":"rotate("+Game.Ball.bowMovePosition.rotateR+"deg)","-webkit-transform":"rotate("+Game.Ball.bowMovePosition.rotateR+"deg)","-moz-transform":"rotate("+Game.Ball.bowMovePosition.rotateR+"deg)","-o-transform":"rotate("+Game.Ball.bowMovePosition.rotateR+"deg)","-ms-transform":"rotate("+Game.Ball.bowMovePosition.rotateR+"deg)"});if($(".flyball").offset().top<=Game.Ball.originPosition.top){clearInterval(c);$(".ballmain .l,.ballmain .r").removeAttr("style");}},10);},resetBall:function(){$(".ballmain .ball").removeAttr("style");Game.Ball.startPosition=Game.Ball.movePosition={};$(".page3 .hand").show();$(".flyball").removeAttr("style");},updateStatus:function(){if(Game.Ball.success==true){$(".page3 .number").text().replace("x","");var a=parseInt($(".page3 .number").text().replace("x",""))+1;$(".page3 .number").text("x"+a);}$(".page3 .bar").children(".icon").eq(Game.Ball.timer++).hide();if(Game.Ball.timer==10){setTimeout(function(){Game.end();},1000);}},end:function(){var c=parseInt($(".page3 .number").text().replace("x",""));Game.Result.score=c;localStorage.setItem("gameScore",c);c=9;var a=Game.Clock.timeInfo[0];var b={sid:Bmh.getSid(),channelType:Bmh.getChannelType(),userId:Bmh.getOpenid(),deviceType:Bmh.getDeviceType(),hitCount:c};if(amGloble.config.debug==true){alert("[-a02- input]"+JSON.stringify(b));}amGloble.api.a02.post(b,function(e){if(amGloble.config.debug==true){alert("[-a02- return]"+JSON.stringify(e));}if(e.content.errCode!=0||e.content.data==null){if(amGloble.config.debug==true){alert(JSON.stringify(e));}}else{var f=e.content.data.result;var d=7;Game.Result.flag=f;if(f==0){d=6;sessionStorage.setItem("promoCode",e.content.data.promoCode);localStorage.setItem("localPromoCode",e.content.data.promoCode);}else{if(f==1){d=7;sessionStorage.setItem("promoCode","");}else{d=8;sessionStorage.setItem("promoCode","");}}if(localStorage.getItem("gameScore")>=3){$("title").html("我用"+a+"s制造了"+Game.Result.score+"次邂逅！半价畅享夏日甜蜜！你也可以哦！");}else{$("title").html("制造甜蜜邂逅，分分钟体验半价新享法。骚年！等你来哦！");}Bmh.goToPage(d);}},"application/json; charset=utf-8");this.reset();},reset:function(){if(Game.Clock.updateTimer){clearInterval(Game.Clock.updateTimer);}Game.Clock.timeInfo=[0,0];$(".page3 .time_button>span").text(Game.Clock.timeInfo.join(":"));$(".page3 .bar .icon").show();$(".page3 .number").text("x0");Game.Ball.timer=0;}};
